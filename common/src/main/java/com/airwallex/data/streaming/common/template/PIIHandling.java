package com.airwallex.data.streaming.common.template;

import com.airwallex.data.streaming.common.rowformat.MyAvroRowDeserializationSchema;
import org.apache.avro.Schema;
import org.apache.avro.SchemaParseException;
import org.apache.flink.api.common.functions.MapFunction;
import org.apache.flink.contrib.streaming.state.RocksDBStateBackend;
import org.apache.flink.streaming.api.CheckpointingMode;
import org.apache.flink.streaming.api.TimeCharacteristic;
import org.apache.flink.streaming.api.datastream.DataStream;
import org.apache.flink.streaming.api.environment.CheckpointConfig;
import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
import org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumer;
import org.apache.flink.table.api.EnvironmentSettings;
import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;
import org.apache.flink.types.Row;

import java.util.List;
import java.util.Properties;

public class PIIHandling {

    public static void main(String[] args) throws Exception {
        // create execution environment
        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);

        // EnvironmentSettings fsSettings = EnvironmentSettings.newInstance().useOldPlanner().inStreamingMode().build();
        EnvironmentSettings fsSettings = EnvironmentSettings.newInstance().useBlinkPlanner().inStreamingMode().build();

        StreamTableEnvironment fsTableEnv = StreamTableEnvironment.create(env, fsSettings);

        CheckpointConfig checkpointConfig = env.getCheckpointConfig();
        checkpointConfig.setFailOnCheckpointingErrors(false);
        checkpointConfig.setCheckpointInterval(10000);
        checkpointConfig.setMinPauseBetweenCheckpoints(5000);
        checkpointConfig.setMaxConcurrentCheckpoints(1);
        checkpointConfig.setCheckpointingMode(CheckpointingMode.AT_LEAST_ONCE);

        RocksDBStateBackend rocksDBStateBackend = new RocksDBStateBackend(
                "gs://petersonwang-workspace/flinkcheckpoint", true);
        //env.setStateBackend((StateBackend) rocksDBStateBackend);

        Properties properties = new Properties();
        properties.setProperty("bootstrap.servers", "data-nonprod-1:9092");
        properties.setProperty("group.id", "flink_consumer_3");
        properties.setProperty("zookeeper.connect", "data-nonprod-1:2181");

        String mockAvroSchema = "{\"type\":\"record\",\"name\":\"PaymentCoreEventMessageDto\",\"namespace\":\"com.airwallex.kotlin.kafka\",\"fields\":[{\"name\":\"paymentAttemptResponseDto\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"PaymentAttemptResponseDto\",\"fields\":[{\"name\":\"paymentAttemptId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentMethod\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentMethodType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentInstrument\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"PaymentInstrumentResponseDto\",\"fields\":[{\"name\":\"id\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"requestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"customerId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentMethod\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentMethodType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"source\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Source\",\"fields\":[{\"name\":\"sourceType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"card\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Card\",\"fields\":[{\"name\":\"fingerPrint\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cvcCheck\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"avsCheck\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cardBin\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"last4\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"expMonth\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"expYear\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"holderName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"panToken\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cvcToken\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null},{\"name\":\"wechat\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Wechat\",\"fields\":[{\"name\":\"outTradeNo\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"chargeType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"openId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"appId\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null}]}],\"default\":null},{\"name\":\"billing\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Billing\",\"fields\":[{\"name\":\"dateOfBirth\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"email\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"firstName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"lastName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"phoneNumber\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"address\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Address\",\"fields\":[{\"name\":\"country\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"state\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"city\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"street\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"postalCode\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null}]}],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"updatedAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null}]}],\"default\":null},{\"name\":\"device\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Device\",\"fields\":[{\"name\":\"deviceId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"browserInfo\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"ipAddress\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"hostName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cookiesAccepted\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"httpBrowserEmail\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"httpBrowserType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"ipNetworkAddress\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"browserDetail\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"BrowserDetail\",\"fields\":[{\"name\":\"userAgent\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"acceptHeader\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"language\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"colorDepth\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"screenHeight\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"screenWidth\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"timeZoneOffset\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"javaEnabled\",\"type\":[\"null\",\"boolean\"],\"default\":null}]}],\"default\":null}]}],\"default\":null},{\"name\":\"capturedAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"refundedAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"currency\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"status\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"updatedAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null}]}],\"default\":null},{\"name\":\"paymentInstrumentResponseDto\",\"type\":[\"null\",\"PaymentInstrumentResponseDto\"],\"default\":null},{\"name\":\"paymentIntentResponseDto\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"PaymentIntentResponseDto\",\"fields\":[{\"name\":\"id\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"requestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"customerId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"totalAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"currency\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"order\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"PurchaseOrder\",\"fields\":[{\"name\":\"products\",\"type\":[\"null\",{\"type\":\"array\",\"items\":{\"type\":\"record\",\"name\":\"PhysicalProduct\",\"fields\":[{\"name\":\"type\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"code\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"name\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"sku\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"quantity\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"unitPrice\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"desc\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"url\",\"type\":[\"null\",\"string\"],\"default\":null}]},\"java-class\":\"java.util.List\"}],\"default\":null},{\"name\":\"shippingData\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Shipping\",\"fields\":[{\"name\":\"firstName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"lastName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"phone\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"shippingMethod\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"address\",\"type\":[\"null\",\"Address\"],\"default\":null}]}],\"default\":null},{\"name\":\"invoiceHeader\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"InvoiceHeader\",\"fields\":[{\"name\":\"giftIndicator\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"returnsAccepted\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"tenderType\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null},{\"name\":\"merchantOrderId\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null},{\"name\":\"email\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"phone\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"descriptor\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"status\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentAttempt\",\"type\":[\"null\",\"PaymentAttemptResponseDto\"],\"default\":null},{\"name\":\"paymentMethods\",\"type\":[\"null\",{\"type\":\"array\",\"items\":{\"type\":\"record\",\"name\":\"PaymentMethod\",\"fields\":[{\"name\":\"id\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"type\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"name\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"schema\",\"type\":[\"null\",\"string\"],\"default\":null}]},\"java-class\":\"java.util.List\"}],\"default\":null},{\"name\":\"paymentInstruments\",\"type\":[\"null\",{\"type\":\"array\",\"items\":\"PaymentInstrumentResponseDto\",\"java-class\":\"java.util.List\"}],\"default\":null},{\"name\":\"capturedAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"updatedAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null}]}],\"default\":null},{\"name\":\"refundResponseDto\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"RefundResponseDto\",\"fields\":[{\"name\":\"id\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"requestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentAttemptId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"refundAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"refundCurrency\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"reason\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cancellationReason\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"status\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"updatedAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null}]}],\"default\":null},{\"name\":\"customerResponseDto\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"CustomerResponseDto\",\"fields\":[{\"name\":\"customerId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantRequestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantCustomerId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"address\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"customerType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"email\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"phone\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"firstName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"lastName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"registerViaSocialMedia\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"firstSuccessfulOrderDate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"registrationDate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"additionalData\",\"type\":[\"null\",{\"type\":\"map\",\"values\":{\"type\":\"record\",\"name\":\"Object\",\"namespace\":\"java.lang\",\"fields\":[]}}],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"created\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null}]}],\"default\":null},{\"name\":\"eventId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"eventType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantAccountId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantRequestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentIntentId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentAttemptId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentDirectiveId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"error\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null}]}";
     //    String avroSchema = "{\"type\":\"record\",\"name\":\"PaymentCoreEventMessageDto\",\"namespace\":\"com.airwallex.kotlin.kafka\",\"fields\":[{\"name\":\"paymentAttemptResponseDto\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"PaymentAttemptResponseDto\",\"fields\":[{\"name\":\"paymentAttemptId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentMethod\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentMethodType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentInstrument\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"PaymentInstrumentResponseDto\",\"fields\":[{\"name\":\"id\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"requestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"customerId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentMethod\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentMethodType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"source\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Source\",\"fields\":[{\"name\":\"sourceType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"card\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Card\",\"fields\":[{\"name\":\"fingerPrint\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cvcCheck\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"avsCheck\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cardBin\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"last4\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"expMonth\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"expYear\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"holderName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"panToken\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cvcToken\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null},{\"name\":\"wechat\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Wechat\",\"fields\":[{\"name\":\"outTradeNo\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"chargeType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"openId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"appId\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null}]}],\"default\":null},{\"name\":\"billing\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Billing\",\"fields\":[{\"name\":\"dateOfBirth\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"email\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"firstName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"lastName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"phoneNumber\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"address\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Address\",\"fields\":[{\"name\":\"country\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"state\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"city\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"street\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"postalCode\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null}]}],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"updatedAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null}]}],\"default\":null},{\"name\":\"device\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Device\",\"fields\":[{\"name\":\"deviceId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"browserInfo\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"ipAddress\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"hostName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cookiesAccepted\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"httpBrowserEmail\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"httpBrowserType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"ipNetworkAddress\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"browserDetail\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"BrowserDetail\",\"fields\":[{\"name\":\"userAgent\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"acceptHeader\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"language\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"colorDepth\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"screenHeight\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"screenWidth\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"timeZoneOffset\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"javaEnabled\",\"type\":[\"null\",\"boolean\"],\"default\":null}]}],\"default\":null}]}],\"default\":null},{\"name\":\"capturedAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"refundedAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"currency\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"status\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"updatedAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null}]}],\"default\":null},{\"name\":\"paymentInstrumentResponseDto\",\"type\":[\"null\",\"PaymentInstrumentResponseDto\"],\"default\":null},{\"name\":\"paymentIntentResponseDto\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"PaymentIntentResponseDto\",\"fields\":[{\"name\":\"id\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"requestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"customerId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"totalAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"currency\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"order\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"PurchaseOrder\",\"fields\":[{\"name\":\"products\",\"type\":[\"null\",{\"type\":\"array\",\"items\":{\"type\":\"record\",\"name\":\"PhysicalProduct\",\"fields\":[{\"name\":\"type\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"code\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"name\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"sku\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"quantity\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"unitPrice\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"desc\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"url\",\"type\":[\"null\",\"string\"],\"default\":null}]},\"java-class\":\"java.util.List\"}],\"default\":null},{\"name\":\"shippingData\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Shipping\",\"fields\":[{\"name\":\"firstName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"lastName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"phone\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"shippingMethod\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"address\",\"type\":[\"null\",\"Address\"],\"default\":null}]}],\"default\":null},{\"name\":\"invoiceHeader\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"InvoiceHeader\",\"fields\":[{\"name\":\"giftIndicator\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"returnsAccepted\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"tenderType\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null},{\"name\":\"merchantOrderId\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null},{\"name\":\"email\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"phone\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"descriptor\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"status\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentAttempt\",\"type\":[\"null\",\"PaymentAttemptResponseDto\"],\"default\":null},{\"name\":\"paymentMethods\",\"type\":[\"null\",{\"type\":\"array\",\"items\":{\"type\":\"record\",\"name\":\"PaymentMethod\",\"fields\":[{\"name\":\"id\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"type\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"name\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"schema\",\"type\":[\"null\",\"string\"],\"default\":null}]},\"java-class\":\"java.util.List\"}],\"default\":null},{\"name\":\"paymentInstruments\",\"type\":[\"null\",{\"type\":\"array\",\"items\":\"PaymentInstrumentResponseDto\",\"java-class\":\"java.util.List\"}],\"default\":null},{\"name\":\"capturedAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"updatedAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null}]}],\"default\":null},{\"name\":\"refundResponseDto\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"RefundResponseDto\",\"fields\":[{\"name\":\"id\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"requestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentAttemptId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"refundAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"refundCurrency\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"reason\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cancellationReason\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"status\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"updatedAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null}]}],\"default\":null},{\"name\":\"customerResponseDto\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"CustomerResponseDto\",\"fields\":[{\"name\":\"customerId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantRequestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantCustomerId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"address\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"customerType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"email\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"phone\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"firstName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"lastName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"registerViaSocialMedia\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"firstSuccessfulOrderDate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"registrationDate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"additionalData\",\"type\":[\"null\",{\"type\":\"map\",\"values\":{\"type\":\"record\",\"name\":\"Object\",\"namespace\":\"java.lang\",\"fields\":[]}}],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"created\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null}]}],\"default\":null},{\"name\":\"eventId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"eventType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantAccountId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantRequestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentIntentId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentAttemptId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentDirectiveId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"error\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null}]}";
       String avroSchema = "{\"type\":\"record\",\"name\":\"PaymentCoreEventMessageDto\",\"namespace\":\"com.airwallex.kotlin.kafka\",\"fields\":[{\"name\":\"paymentAttemptResponseDto\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"PaymentAttemptResponseDto\",\"fields\":[{\"name\":\"paymentAttemptId\",\"type\":[\"null\",\"string\"],\"default\":null,\"pii\":\"hash\"},{\"name\":\"paymentMethod\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentMethodType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentInstrument\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"PaymentInstrumentResponseDto\",\"fields\":[{\"name\":\"id\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"requestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"customerId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentMethod\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentMethodType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"source\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Source\",\"fields\":[{\"name\":\"sourceType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"card\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Card\",\"fields\":[{\"name\":\"fingerPrint\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cvcCheck\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"avsCheck\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cardBin\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"last4\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"expMonth\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"expYear\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"holderName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"panToken\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cvcToken\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null},{\"name\":\"wechat\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Wechat\",\"fields\":[{\"name\":\"outTradeNo\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"chargeType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"openId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"appId\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null}]}],\"default\":null},{\"name\":\"billing\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Billing\",\"fields\":[{\"name\":\"dateOfBirth\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"email\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"firstName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"lastName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"phoneNumber\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"address\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Address\",\"fields\":[{\"name\":\"country\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"state\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"city\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"street\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"postalCode\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null}]}],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"updatedAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null}]}],\"default\":null},{\"name\":\"device\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Device\",\"fields\":[{\"name\":\"deviceId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"browserInfo\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"ipAddress\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"hostName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cookiesAccepted\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"httpBrowserEmail\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"httpBrowserType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"ipNetworkAddress\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"browserDetail\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"BrowserDetail\",\"fields\":[{\"name\":\"userAgent\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"acceptHeader\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"language\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"colorDepth\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"screenHeight\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"screenWidth\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"timeZoneOffset\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"javaEnabled\",\"type\":[\"null\",\"boolean\"],\"default\":null}]}],\"default\":null}]}],\"default\":null},{\"name\":\"capturedAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"refundedAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"currency\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"status\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"updatedAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null}]}],\"default\":null},{\"name\":\"paymentInstrumentResponseDto\",\"type\":[\"null\",\"PaymentInstrumentResponseDto\"],\"default\":null},{\"name\":\"paymentIntentResponseDto\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"PaymentIntentResponseDto\",\"fields\":[{\"name\":\"id\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"requestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"customerId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"totalAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"currency\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"order\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"PurchaseOrder\",\"fields\":[{\"name\":\"products\",\"type\":[\"null\",{\"type\":\"array\",\"items\":{\"type\":\"record\",\"name\":\"PhysicalProduct\",\"fields\":[{\"name\":\"type\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"code\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"name\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"sku\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"quantity\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"unitPrice\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"desc\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"url\",\"type\":[\"null\",\"string\"],\"default\":null}]},\"java-class\":\"java.util.List\"}],\"default\":null},{\"name\":\"shippingData\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"Shipping\",\"fields\":[{\"name\":\"firstName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"lastName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"phone\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"shippingMethod\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"address\",\"type\":[\"null\",\"Address\"],\"default\":null}]}],\"default\":null},{\"name\":\"invoiceHeader\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"InvoiceHeader\",\"fields\":[{\"name\":\"giftIndicator\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"returnsAccepted\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"tenderType\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null},{\"name\":\"merchantOrderId\",\"type\":[\"null\",\"string\"],\"default\":null}]}],\"default\":null},{\"name\":\"email\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"phone\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"descriptor\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"status\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentAttempt\",\"type\":[\"null\",\"PaymentAttemptResponseDto\"],\"default\":null},{\"name\":\"paymentMethods\",\"type\":[\"null\",{\"type\":\"array\",\"items\":{\"type\":\"record\",\"name\":\"PaymentMethod\",\"fields\":[{\"name\":\"id\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"type\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"name\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"schema\",\"type\":[\"null\",\"string\"],\"default\":null}]},\"java-class\":\"java.util.List\"}],\"default\":null},{\"name\":\"paymentInstruments\",\"type\":[\"null\",{\"type\":\"array\",\"items\":\"PaymentInstrumentResponseDto\",\"java-class\":\"java.util.List\"}],\"default\":null},{\"name\":\"capturedAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"updatedAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null}]}],\"default\":null},{\"name\":\"refundResponseDto\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"RefundResponseDto\",\"fields\":[{\"name\":\"id\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"requestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentAttemptId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"refundAmount\",\"type\":[\"null\",{\"type\":\"string\",\"java-class\":\"java.math.BigDecimal\"}],\"default\":null},{\"name\":\"refundCurrency\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"reason\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cancellationReason\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"status\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"updatedAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null}]}],\"default\":null},{\"name\":\"customerResponseDto\",\"type\":[\"null\",{\"type\":\"record\",\"name\":\"CustomerResponseDto\",\"fields\":[{\"name\":\"customerId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantRequestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantCustomerId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"address\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"customerType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"email\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"phone\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"firstName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"lastName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"registerViaSocialMedia\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"firstSuccessfulOrderDate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"registrationDate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"additionalData\",\"type\":[\"null\",{\"type\":\"map\",\"values\":{\"type\":\"record\",\"name\":\"Object\",\"namespace\":\"java.lang\",\"fields\":[]}}],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null},{\"name\":\"created\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null}]}],\"default\":null},{\"name\":\"eventId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"eventType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantAccountId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantRequestId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentIntentId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentAttemptId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentDirectiveId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"createdAt\",\"type\":[\"null\",{\"type\":\"long\"}],\"default\":null},{\"name\":\"error\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"liveMode\",\"type\":[\"null\",\"boolean\"],\"default\":null}]}";
        MyAvroRowDeserializationSchema avroDes = new MyAvroRowDeserializationSchema(avroSchema);

        FlinkKafkaConsumer consumer = new FlinkKafkaConsumer<>("peterson.mockacquiring", avroDes, properties);

        DataStream<Row> stream = env.addSource(consumer);

        stream = stream.map(new MapFunction<Row, Row>() {

            @Override
            public Row map(Row row) throws Exception {

                final Schema schema;
                try {
                    schema = new Schema.Parser().parse(avroSchema);
                    Row convertedRow =  CheckPiiData(schema, row);
                    return convertedRow;
                } catch (SchemaParseException e) {
                    throw new IllegalArgumentException("Could not parse Avro schema string.", e);
                }

            }

        });

        stream.print();

        env.execute();

    }

    private static Row CheckPiiData(Schema schema, Row row){
        List<Schema.Field> fields = schema.getFields();
        int length = fields.size();
        for(int i = 0; i < length; ++i) {
            Schema.Field field = (Schema.Field)fields.get(i);
            Object fieldInfo = row.getField(i);

            if(field.getProp("pii") != null && field.getProp("pii").equals("hash")){
                row.setField(i, filedMask(field.schema(), fieldInfo));
            }
            else{
                row.setField(i, checkFiledPii(field.schema(), fieldInfo));
            }

        }

        return row;

    }

    private static Object filedMask(Schema schema, Object object){
        if (object == null) {
            return null;
        }
        else {
            switch (schema.getType()) {
                case STRING:
                    return piiMask(schema, object.toString());
                case UNION:
                    List<Schema> types = schema.getTypes();
                    int size = types.size();
                    if (size == 2 && ((Schema) types.get(0)).getType() == Schema.Type.NULL) {
                        return filedMask((Schema) types.get(1), object);
                    } else if (size == 2 && ((Schema) types.get(1)).getType() == Schema.Type.NULL) {
                        return filedMask((Schema) types.get(0), object);
                    } else {
                        if (size == 1) {
                            return filedMask((Schema) types.get(0), object);
                        }
                        return object;
                    }
                default:
                    throw new IllegalStateException("Unsupported PII data type: " + object.getClass());
            }
        }
    }

    private static Object checkFiledPii(Schema schema, Object object){
        if (object == null) {
            return null;
        }
        else{
            switch(schema.getType()) {
                case RECORD:
                    if (object instanceof Row) {
                        return CheckPiiData(schema, (Row)object);
                    }
                    throw new IllegalStateException("Row expected but was: " + object.getClass());
                case ENUM:
                case STRING:
                    return object.toString();
                case UNION:
                    List<Schema> types = schema.getTypes();
                    int size = types.size();
                    if (size == 2 && ((Schema)types.get(0)).getType() == Schema.Type.NULL) {
                        return checkFiledPii((Schema)types.get(1), object);
                    } else if (size == 2 && ((Schema)types.get(1)).getType() == Schema.Type.NULL) {
                        return checkFiledPii((Schema)types.get(0), object);
                    } else {
                        if (size == 1) {
                            return checkFiledPii((Schema)types.get(0), object);
                        }
                        return object;
                    }

                default:
                    return object;

            }

        }

    }

    private static String piiMask(Schema schema, Object object){
        if (object == null){
            return null;
        }
        else{
            if (object instanceof String) {
                return String.valueOf(((String)object).hashCode());
            }
            return null;
        }
    }




}
